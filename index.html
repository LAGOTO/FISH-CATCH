<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ò–≥—Ä–∞–π ‚Äì –ö—ä—Å–º–µ—Ç –∑–∞ —É–ª–æ–≤–∞</title>
  <style>
    :root{
      --sea1:#0c2747; --sea2:#144a7a; --sky1:#87cefa; --sky2:#cfeaff; --foam:#d6ecff; --ui:#ffffff; --accent:#7bd389; --muted:#cfe2f5;
    }
    html,body{height:100%;margin:0}
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif; background:linear-gradient(#071426,#0a1b2a); color:var(--ui); display:flex; align-items:center; justify-content:center}

    .game{width:min(1100px,96vw); aspect-ratio:16/9; position:relative; border-radius:20px; overflow:hidden; box-shadow:0 18px 50px rgba(0,0,0,.55); background:radial-gradient(1200px 600px at 50% -40%, var(--sky2), var(--sea1) 60%)}
    header{position:absolute; left:12px; right:12px; top:12px; display:flex; justify-content:space-between; align-items:center; z-index:5}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px}
    .dot{width:12px; height:12px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent)}
    .pill{backdrop-filter: blur(6px); background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.18); padding:6px 10px; border-radius:999px; font-weight:700}

    /* Lake drawing */
    .lake{position:absolute; inset:0;}
    .water{position:absolute; left:0; right:0; top:20%; bottom:0; background:linear-gradient(180deg, var(--sea2), var(--sea1));}
    .shore{position:absolute; left:0; right:0; bottom:0; height:14%; background:linear-gradient(180deg,#3c2b1a,#24190f);} 
    .ripples{position:absolute; inset:0; pointer-events:none;}

    /* Grid */
    .grid{position:absolute; left:6%; right:6%; top:22%; bottom:16%; display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); gap:10px}
    .cell{position:relative; border-radius:12px; outline:1px dashed rgba(255,255,255,.18); background:rgba(255,255,255,.05); cursor:pointer; transition:transform .08s ease, background .15s ease}
    .cell:hover{transform:translateY(-2px); background:rgba(255,255,255,.08)}
    .cell span{position:absolute; left:8px; top:6px; font-size:12px; color:var(--muted)}

    /* Overlays */
    .overlay{position:absolute; inset:0; display:grid; place-items:center; z-index:10}
    .card{background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.18); border-radius:16px; padding:22px; max-width:640px}
    .title{margin:0 0 8px; font-size:clamp(20px,3.4vw,30px)}
    .sub{margin:0 0 16px; color:#e5f1ff}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    button{cursor:pointer; border:0; border-radius:12px; padding:10px 14px; font-weight:800}
    .btn{background:var(--accent)}
    .btn-ghost{background:transparent; color:#fff; outline:1px solid rgba(255,255,255,.35)}

    /* Result sheet */
    .result{position:absolute; right:12px; bottom:12px; z-index:9;}
    .sheet{background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.18); border-radius:16px; padding:14px 16px; min-width:260px}
    .sheet h3{margin:0 0 8px}
    .kv{display:grid; grid-template-columns: auto 1fr; gap:6px 12px; font-size:14px}
    .kv div{opacity:.95}

    /* Casting ripple */
    .splash{position:absolute; width:8px; height:8px; border-radius:50%; background:#fff; opacity:.9; pointer-events:none; transform:translate(-50%,-50%); animation:splash 1.2s ease-out forwards}
    @keyframes splash{ 0%{box-shadow:0 0 0 0 rgba(255,255,255,.6);} 100%{box-shadow:0 0 0 30px rgba(255,255,255,0); opacity:0} }

    footer{position:absolute; inset:auto 12px 10px 12px; color:#d0e2f6; font-size:12px; display:flex; justify-content:space-between}
  </style>
</head>
<body>
  <div class="game" id="game">
    <header>
      <div class="brand"><span class="dot"></span> QR –ö—ä—Å–º–µ—Ç <b>HASWING</b></div>
      <div class="pill">–ó–∞–º–µ—Ç–Ω–∏!</div>
    </header>

    <div class="lake">
      <div class="water"></div>
      <div class="grid" id="grid"></div>
      <div class="ripples" id="ripples"></div>
      <div class="shore"></div>
    </div>

    <div class="result" id="result" style="display:none">
      <div class="sheet">
        <h3 class="title" style="font-size:20px">–ö—ä—Å–º–µ—Ç—ä—Ç —Ç–∏ –¥–Ω–µ—Å</h3>
        <div class="kv">
          <div>–†–∏–±–∞:</div><div id="r-fish">‚Äì</div>
          <div>–¢–µ–≥–ª–æ:</div><div id="r-weight">‚Äì</div>
          <div>–î—ä–ª–±–æ—á–∏–Ω–∞ –Ω–∞ –∫—ä–ª–≤–∞–Ω–µ—Ç–æ:</div><div id="r-depth">‚Äì</div>
          <div>–í—Ä–µ–º–µ –Ω–∞ —á–∞–∫–∞–Ω–µ:</div><div id="r-wait">‚Äì</div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="again">–ò–≥—Ä–∞–π –ø–∞–∫</button>
          <button class="btn-ghost" id="share">–°–ø–æ–¥–µ–ª–∏</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="start">
      <div class="card">
        <h1 class="title">–°–∫–∞–Ω–∏—Ä–∞ QR –∫–æ–¥–∞? –î–æ–±—Ä–µ –¥–æ—à—ä–ª!</h1>
        <p class="sub">‚Äû–ò–≥—Ä–∞–π, –∑–∞ –¥–∞ –≤–∏–¥–∏—à –∫—ä—Å–º–µ—Ç–∞ —Å–∏ –∏ –∫–∞–∫–≤–∞ —Ä–∏–±–∞ —â–µ —Ö–≤–∞–Ω–µ—à.‚Äú
          –ò–∑–±–µ—Ä–∏ –∑–æ–Ω–∞ –∑–∞ –∑–∞–º—è—Ç–∞–Ω–µ (3√ó3 –ø—Ä–µ–¥ —Ç–µ–±) –∏ –≤–∏–∂ –∫–∞–∫–≤–æ —â–µ –≤–∑–µ–º–µ —Å—Ç—Ä—ä–≤—Ç–∞.</p>
        <div class="row">
          <button class="btn" id="play">–°—Ç–∞—Ä—Ç</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="howCard" style="display:none">
      <div class="card">
        <h2 class="title">–ö–∞–∫ —Å–µ –∏–≥—Ä–∞–µ</h2>
        <ul style="line-height:1.55; margin:0 0 14px 18px">
          <li>–ò–∑–±–µ—Ä–∏ –µ–¥–Ω–∞ –æ—Ç <b>9‚Äë—Ç–µ –∑–æ–Ω–∏</b> –ø—Ä–µ–¥ —Ç–µ–± (–ª—è–≤–æ/–¥—è—Å–Ω–æ, –±–ª–∏–∑–æ/—Å—Ä–µ–¥–Ω–æ/–¥–∞–ª–µ—á).</li>
          <li>–í—Å—è–∫–∞ –∑–æ–Ω–∞ –∏–º–∞ —Ä–∞–∑–ª–∏—á–µ–Ω —à–∞–Ω—Å –∑–∞ <b>–∫–æ—Å—Ç—É—Ä</b>, <b>—â—É–∫–∞</b>, <b>–±—è–ª–∞ —Ä–∏–±–∞</b> –∏–ª–∏ <b>—Å–æ–º</b>.</li>
          <li>–©–µ –ø–æ–ª—É—á–∏—à –∫—ä—Å–º–µ—Ç: –≤–∏–¥ —Ä–∏–±–∞, <b>—Ç–µ–≥–ª–æ</b>, <b>–¥—ä–ª–±–æ—á–∏–Ω–∞ –Ω–∞ –∫—ä–ª–≤–∞–Ω–µ—Ç–æ</b> –∏ <b>–≤—Ä–µ–º–µ –Ω–∞ —á–∞–∫–∞–Ω–µ</b>.</li>
        </ul>
        <div class="row">
          <button class="btn" id="play2">–ò–≥—Ä–∞–π —Å–µ–≥–∞</button>
          <button class="btn-ghost" id="closeHow">–ó–∞—Ç–≤–æ—Ä–∏</button>
        </div>
      </div>
    </div>

    <footer>
      <div>¬©Lago.bg</div>
    </footer>
  </div>

<script>
(() => {
  'use strict';
  // Ensure DOM is ready even if this script is moved to <head>
  window.addEventListener('DOMContentLoaded', init);

  function init(){
    // ===== Query elements (single scope) =====
    const grid = document.getElementById('grid');
    const ripples = document.getElementById('ripples');
    const startUI = document.getElementById('start');
    const howUI = document.getElementById('howCard');
    const playBtns = [document.getElementById('play'), document.getElementById('play2')];
    const howBtn = document.getElementById('how');
    const closeHow = document.getElementById('closeHow');
    const resultWrap = document.getElementById('result');
    const rFish = document.getElementById('r-fish');
    const rW = document.getElementById('r-weight');
    const rD = document.getElementById('r-depth');
    const rT = document.getElementById('r-wait');
    const again = document.getElementById('again');
    const share = document.getElementById('share');

    // ===== Guard: if critical elements missing, abort gracefully =====
    const required = {grid,ripples,startUI,howUI,playBtns,howBtn,closeHow,resultWrap,rFish,rW,rD,rT,again,share};
    for(const [k,v] of Object.entries(required)){
      if(v==null || (Array.isArray(v) && v.some(x=>x==null))){
        console.error('QR Fish Luck ‚Äì missing element:', k);
        return; // avoid ReferenceErrors
      }
    }

    // ===== Audio (inside same scope) =====
    let actx;
    const ctx = () => actx || (actx = new (window.AudioContext||window.webkitAudioContext)());
    function ensureAudio(){ try{ const a=ctx(); if(a.state==='suspended') a.resume(); }catch(e){} }
    function beep(freq=440, dur=120, type='sine', vol=0.2){
      ensureAudio();
      const a=ctx(); const o=a.createOscillator(); const g=a.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(a.destination);
      const t=a.currentTime; o.start(t); o.stop(t+dur/1000);
      g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(0.001, t+dur/1000);
    }
    const playSplash = () => beep(220,90,'sine',0.08);
    const playCatch = (f) => { const map={perch:520,pike:360,zander:300,catfish:180}; beep(map[f.id]||400,160,'triangle',0.15); };

    // ===== Build 3x3 grid (near at bottom) =====
    const rows=3, cols=3; let cells=[];
    function build(){
      grid.innerHTML=''; cells=[];
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const cell=document.createElement('div'); cell.className='cell';
          const lab=document.createElement('span');
          const dist = r===2? '–±–ª–∏–∑–æ' : r===1? '—Å—Ä–µ–¥–Ω–æ' : '–¥–∞–ª–µ—á'; // bottom row is near
          const col = c===0? '–ª—è–≤–æ' : c===1? '—Ü–µ–Ω—Ç—ä—Ä' : '–¥—è—Å–Ω–æ';
          lab.textContent = `${dist} ‚Ä¢ ${col}`; cell.appendChild(lab);
          cell.dataset.r=r; cell.dataset.c=c;
          cell.addEventListener('click', ()=> cast(r,c,cell));
          cells.push(cell); grid.appendChild(cell);
        }
      }
    }

    // ===== Species & probabilities =====
    const species = [
      {id:'perch',   name:'–ö–æ—Å—Ç—É—Ä',     emoji:'üêü', w:[0.1,1.2],  depth:[1.0,4.0], wait:[5,40]},
      {id:'pike',    name:'–©—É–∫–∞',       emoji:'ü¶à', w:[0.8,8.0],  depth:[0.5,2.5], wait:[10,60]},
      {id:'zander',  name:'–ë—è–ª–∞ —Ä–∏–±–∞',  emoji:'üê†', w:[0.7,4.5],  depth:[2.0,8.0], wait:[15,120]},
      {id:'catfish', name:'–°–æ–º',        emoji:'üê°', w:[2.0,30.0], depth:[3.0,10.0], wait:[30,180]}
    ];

    // far (top), mid, near (bottom) ‚Üí [perch, pike, zander, catfish]
    const distRowWeights = [
      [0.25, 0.20, 0.45, 0.10], // far ‚Äì –ø–æ–≤–µ—á–µ –±—è–ª–∞ —Ä–∏–±–∞, –ø–æ-—Ä—è–¥—ä–∫ —Å–æ–º
      [0.40, 0.30, 0.25, 0.05], // mid ‚Äì –ø–æ–≤–µ—á–µ –∫–æ—Å—Ç—É—Ä, —É–º–µ—Ä–µ–Ω–∞ —â—É–∫–∞
      [0.55, 0.30, 0.12, 0.03]  // near ‚Äì –Ω–∞–π-–º–Ω–æ–≥–æ –∫–æ—Å—Ç—É—Ä, —Å–æ–º –ø–æ—á—Ç–∏ –ª–∏–ø—Å–≤–∞
    ];

    // ===== Helpers =====
    const rnd = (a,b) => Math.random()*(b-a)+a;
    const clamp = (v,a,b) => Math.max(a, Math.min(b,v));
    function fmtWait(sec){ if(sec<60) return `${sec} —Å–µ–∫`; const m=Math.floor(sec/60), s=sec%60; return s? `${m} –º–∏–Ω ${s} —Å–µ–∫` : `${m} –º–∏–Ω`; }
    function pickWeighted(arr){ const x=Math.random(); let acc=0; for(let i=0;i<arr.length;i++){ acc+=arr[i]; if(x<=acc) return i; } return arr.length-1; }

    // ===== UI actions =====
    function splash(x,y){
      const s=document.createElement('div'); s.className='splash';
      s.style.left = `${x + grid.offsetLeft}px`; s.style.top = `${y + grid.offsetTop}px`;
      ripples.appendChild(s); setTimeout(()=>s.remove(), 1200);
    }

    function display(f, weight, depth, wait){
      rFish.textContent = `${f.emoji} ${f.name}`;
      rW.textContent = `${weight.toFixed(weight<1?2:1)} –∫–≥`;
      rD.textContent = `${depth.toFixed(1)} –º`;
      rT.textContent = fmtWait(wait);
      resultWrap.style.display='block';
    }

    function cast(r,c,cell){
      // visual splash
      const rect = cell.getBoundingClientRect();
      const grect = grid.getBoundingClientRect();
      const x = rect.left + rect.width/2 - grect.left;
      const y = rect.top + rect.height/2 - grect.top;
      splash(x,y); playSplash();

      // choose fish by row probabilities
      const fishId = pickWeighted(distRowWeights[r]);
      const f = species[fishId];

      // stats
      const depthAdj = r===2? -0.6 : r===1? 0 : 0.6; // –±–ª–∏–∑–æ=–ø–æ-–ø–ª–∏—Ç–∫–æ, –¥–∞–ª–µ—á=–ø–æ-–¥—ä–ª–±–æ–∫–æ
      const weight = rnd(f.w[0], f.w[1]);
      const depth = clamp(rnd(f.depth[0], f.depth[1]) + depthAdj, 0.4, 12);
      const wait = Math.round(rnd(f.wait[0], f.wait[1]));

      // small trophy chance for bigger species
      if(Math.random()<0.06){
        const extra = rnd(1.08,1.25);
        if(f.id==='pike' || f.id==='catfish'){
          rFish.textContent = `${f.emoji} ${f.name} (—Ç—Ä–æ—Ñ–µ–π!)`;
        }
        display(f, weight*extra, depth, wait + 10);
        playCatch(f);
      } else {
        display(f, weight, depth, wait);
        playCatch(f);
      }
    }

    // Buttons
    playBtns.forEach(b=>b.addEventListener('click', ()=>{ startUI.style.display='none'; howUI.style.display='none'; build(); }));
    howBtn.addEventListener('click', ()=>{ startUI.style.display='none'; howUI.style.display='grid'; });
    closeHow.addEventListener('click', ()=>{ howUI.style.display='none'; startUI.style.display='grid'; });
    again.addEventListener('click', ()=>{ resultWrap.style.display='none'; beep(440,80,'square',0.08); });
    share.addEventListener('click', ()=>{
      const text = `–ö—ä—Å–º–µ—Ç—ä—Ç –º–∏ –æ—Ç Lago QR: ${rFish.textContent}, ${rW.textContent}, ${rD.textContent}, ${rT.textContent}!`;
      const url = location.href;
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
    });

    // ===== Simple runtime tests (logged to console) =====
    runTests();
    function runTests(){
      try{
        // Elements present
        const ids=['grid','ripples','start','howCard','play','play2','how','closeHow','result','r-fish','r-weight','r-depth','r-wait','again','share'];
        const missing = ids.filter(id=>!document.getElementById(id));
        console.assert(missing.length===0, '–õ–∏–ø—Å–≤–∞—â–∏ –µ–ª–µ–º–µ–Ω—Ç–∏:', missing);
        // fmtWait formatting
        console.assert(fmtWait(45)==='45 —Å–µ–∫', 'fmtWait 45 —Å–µ–∫');
        console.assert(fmtWait(60)==='1 –º–∏–Ω', 'fmtWait 60 —Å–µ–∫');
        console.assert(fmtWait(125)==='2 –º–∏–Ω 5 —Å–µ–∫', 'fmtWait 125 —Å–µ–∫');
        // Weighted pick returns a valid index
        const idx = pickWeighted([0.5,0.3,0.2]);
        console.assert(Number.isInteger(idx) && idx>=0 && idx<3, 'pickWeighted idx', idx);
      }catch(e){ console.warn('–¢–µ—Å—Ç–æ–≤–µ—Ç–µ —Å—Ä–µ—â–Ω–∞—Ö–∞ –≥—Ä–µ—à–∫–∞:', e); }
    }
  }
})();
</script>
</body>
</html>
